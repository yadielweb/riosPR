<!DOCTYPE html>
<html style="font-size: 16px;">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <meta name="page_type" content="np-template-header-footer-from-plugin">
    <title>ríosPR</title>
    <link rel="stylesheet" href="nicepage.css" media="screen">
<link rel="stylesheet" href="ríosPR.css" media="screen">
    <script class="u-script" type="text/javascript" src="jquery.js" defer=""></script>
    <script class="u-script" type="text/javascript" src="nicepage.js" defer=""></script>
    <meta name="generator" content="Nicepage 3.15.3, nicepage.com">
    <link id="u-theme-google-font" rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i|Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i">
    
    
    
    <script type="application/ld+json">{
		"@context": "http://schema.org",
		"@type": "Organization",
		"name": "embalsesPR",
		"url": "index.html"
}</script>
    <meta property="og:title" content="ríosPR">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#478ac9">
    <link rel="canonical" href="index.html">
    <meta property="og:url" content="index.html">
  </head>
  <body data-home-page="ríosPR.html" data-home-page-title="ríosPR" class="u-body"><header class="u-clearfix u-header u-header" id="sec-fd80"><div class="u-clearfix u-sheet u-valign-middle u-sheet-1">
        <nav class="u-menu u-menu-dropdown u-offcanvas u-menu-1">
          <div class="menu-collapse" style="font-size: 1rem; letter-spacing: 0px;">
            <a class="u-button-style u-custom-left-right-menu-spacing u-custom-padding-bottom u-custom-top-bottom-menu-spacing u-nav-link u-text-active-palette-1-base u-text-hover-palette-2-base" href="#">
              <svg><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#menu-hamburger"></use></svg>
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><symbol id="menu-hamburger" viewBox="0 0 16 16" style="width: 16px; height: 16px;"><rect y="1" width="16" height="2"></rect><rect y="7" width="16" height="2"></rect><rect y="13" width="16" height="2"></rect>
</symbol>
</defs></svg>
            </a>
          </div>
          <div class="u-custom-menu u-nav-container">
            <ul class="u-nav u-unstyled u-nav-1"><li class="u-nav-item"><a class="u-button-style u-nav-link u-text-active-palette-1-base u-text-hover-palette-2-base" href="ríosPR.html" style="padding: 10px 20px;">ríosPR</a>
</li></ul>
          </div>
          <div class="u-custom-menu u-nav-container-collapse">
            <div class="u-black u-container-style u-inner-container-layout u-opacity u-opacity-95 u-sidenav">
              <div class="u-sidenav-overflow">
                <div class="u-menu-close"></div>
                <ul class="u-align-center u-nav u-popupmenu-items u-unstyled u-nav-2"><li class="u-nav-item"><a class="u-button-style u-nav-link" href="ríosPR.html" style="padding: 10px 20px;">ríosPR</a>
</li></ul>
              </div>
            </div>
            <div class="u-black u-menu-overlay u-opacity u-opacity-70"></div>
          </div>
        </nav>
        <div class="u-image u-image-circle u-image-1" alt="" data-image-width="1500" data-image-height="1567"></div>
      </div></header>
    <section class="u-clearfix u-section-1" id="sec-eed0">
      <div class="u-clearfix u-sheet u-sheet-1">
        <h1 class="u-align-center u-text u-text-1">riosPR</h1>
        <p class="u-align-left u-text u-text-2">riosPR by Yadiel&nbsp;es una aplicación para visualizar el estado actual de los ríos en Puerto Rico utilizando datos del Servicio Geológico de los Estados Unidos (USGS por sus siglas en inglés). Dependiendo del tráfico en el servidor (y los instrumentos del USGS) el tiempo de búsqueda puede variar. Según USGS los datos tienen estado provisional y podrian variar luego de una revisión.&nbsp;<br>
          <br>De ser necesario recarge la página.<br>
          <br>ríosPR es un proyecto de Yadiel E. Torres Laboy para el curso COMP 4010 del Departamento de Matemáticas de la Universidad de Puerto Rico en Humacao. Pueden enviar sus preguntas, comentarios, o sugerencias a<br>
        </p>
        <p class="u-align-left u-text u-text-3">
          <a class="u-active-none u-border-none u-btn u-button-link u-button-style u-hover-none u-none u-text-palette-1-base u-btn-1" href="mailto:yadiel.torres1@upr.edu">yadiel.torres1@upr.edu</a>
        </p>
      </div>
    </section>
    <section class="u-clearfix u-section-2" id="sec-47a6">
      <div class="u-clearfix u-sheet u-valign-top u-sheet-1">
        <div class="u-clearfix u-custom-html u-expanded-width-xs u-custom-html-1">
          <title></title>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico">
          <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="">
          <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
          <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
          <div id="mapid" style="width: 800px; height:600px;"></div>
          <div>
            <script> /////////////////////
		// Variables globales
		/////////////////////
		let mymap,
			siteDict = {},
			fecha1 = Date(),
			dia = fecha1.slice(0,3),
			mes = fecha1.slice(4,7),
			hora = fecha1.slice(16,18),
			nameDia = { "Mon":"Lunes", "Tue":"Martes", "Wed":"Miércoles",
						 "Thu":"Jueves", "Fri":"Viernes", "Sat":"Sábado",
						 "Sun":"Domingo"},
			nameMes = { "Jan":"Enero", "Feb":"Febrero", "Mar":"Marzo",
						 "Apr":"Abril", "May":"Mayo", "Jun":"Junio",
						 "Jul":"Julio", "Aug":"Agosto", "Sep":"Septiembre",
						 "Oct":"Octubre", "Nov":"Noviembre", "Dic":"Diciembre"},
			horas = { "00":"12", "01":"1", "02":"2", "03":"3", "04":"4", "05":"5",
					  "06":"6", "07":"7", "08":"8", "09":"9", "10":"10", "11":"11",
					  "12":"12", "13":"1", "14":"2", "15":"3", "16":"4", "17":"5",
					  "18":"6", "19":"7", "20":"8", "21":"9", "22":"10", "23":"11" },
			numero_rios = [50059000, 50045000, 50076800, 50047550,
						   50093045, 50111210, 50039995, 50026140,
						   50071225, 50010800, 50113950];
		///////////////////////////////////
		// Funcion para inicializar el mapa
		///////////////////////////////////
		function inicializaMapa()
		{
		  let centro = [18.25178,-66.254513]; 
		  mymap = L.map('mapid').setView(centro, 9);
		  let atrib1 = 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">';
		  let atrib2 = 'OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>';
		  let atrib  = atrib1 + atrib2;
		  let mytoken = 'pk.eyJ1IjoibWVjb2JpIiwiYSI6IjU4YzVlOGQ2YjEzYjE3NTcxOTExZTI2OWY3Y2Y1ZGYxIn0.LUg7xQhGH2uf3zA57szCyw';
		  let myLayer = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}';
		  L.tileLayer(myLayer, {
				attribution: atrib,
				maxZoom: 24,
				id: 'mapbox/streets-v11',
				tileSize: 512,
				zoomOffset: -1,
				accessToken: mytoken}).addTo(mymap);
		}
		////////////////////////////////////////////////////////////////
		// Funcion la cual crea un diccionario con los datos de los ríos
		////////////////////////////////////////////////////////////////
		function createDictionary()
		{
		  let url = "https://raw.githubusercontent.com/yadielweb/riosPR/main/rios.csv";
		  Plotly.d3.csv(url,function(data){
			for(let i=0;i < data.length;i++)
			{
			  siteDict[data[i].id] = {nombre:data[i].nombre,
									  lat:data[i].lat,
									  lon:data[i].lon,
									  tsID:data[i].ts_id,
									  webID:data[i].id2};
			}
		  });
		}
		////////////////////////////////////////////////////////////////////////////////
		// Funcion para filtrar la fecha y nivel del flujo de los ríos en el diccionario
		////////////////////////////////////////////////////////////////////////////////
		function filtraDatos(data)
		{
		  let fecha = [],
			  nivel = [];
		  const filtered = data.split('\n');
		  let colPercentil;
		  for(let i=0;i < filtered.length;i++)
		  {
			if (filtered[i].slice(0,9) == "agency_cd")
			{
			  let header = filtered[i].split("\t");
			  colPercentil = header.findIndex(element => element.includes("_00060"))
			}
			if(filtered[i].slice(0,4) == "USGS")
			{
			  let fila = filtered[i].split('\t');
			  fecha.push(fila[2]);
			  nivel.push(parseFloat(fila[colPercentil]));
			}    
		  }
		  return [fecha, nivel];
		}
		////////////////////////////////////////////////////////////////////////////////
		// Funcion para filtrar la fecha y los percentiles de los ríos en el diccionario
		////////////////////////////////////////////////////////////////////////////////
		function filtraDatos2(data)
		{
		  let fecha = [],
			  per05 = [],
			  per10 = [],
			  per20 = [],
			  per25 = [],
			  per50 = [],
			  per75 = [],
			  per80 = [],
			  per90 = [],
			  per95 = [];
		  const filtered = data.split('\n');
		  let colP05, colP10, colP20, colP25, colP50, colP75, colP80, colP90, colP95;
		  for(let i=0;i < filtered.length;i++)
		  {
			if (filtered[i].slice(0,9) == "agency_cd")
			{
			  let header = filtered[i].split("\t");
			  colP05 = header.findIndex(element => element.includes("p05_va"))
			  colP10 = header.findIndex(element => element.includes("p10_va"))
			  colP20 = header.findIndex(element => element.includes("p20_va"))      
			  colP25 = header.findIndex(element => element.includes("p25_va"))
			  colP50 = header.findIndex(element => element.includes("p50_va"))
			  colP75 = header.findIndex(element => element.includes("p75_va"))
			  colP80 = header.findIndex(element => element.includes("p80_va"))
			  colP90 = header.findIndex(element => element.includes("p90_va"))
			  colP95 = header.findIndex(element => element.includes("p95_va"))
			}
			if(filtered[i].slice(0,4) == "USGS")
			{
			  let fila = filtered[i].split('\t');
			  fecha.push(fila[2]);
			  per05.push(parseFloat(fila[colP05]));
			  per10.push(parseFloat(fila[colP10]));
			  per20.push(parseFloat(fila[colP20]));
			  per25.push(parseFloat(fila[colP25]));
			  per50.push(parseFloat(fila[colP50]));
			  per75.push(parseFloat(fila[colP75]));
			  per80.push(parseFloat(fila[colP80]));
			  per90.push(parseFloat(fila[colP90]));
			  per95.push(parseFloat(fila[colP95]));
			}    
		  }
		  return[fecha, per05, per10, per20, per25, per50, per75, per80, per90, per95]
		}
		//////////////////////////////////////////////
		// Funcion para crear las graficas de cada río
		//////////////////////////////////////////////
		function graficaDatos(filtrado, myDiv)
		{
		  let nivel = filtrado[1].pop();
		  let trace = {
			  x: filtrado[0],
			  y: filtrado[1],
			  type: 'scatter',
			  line: {
				color: 'red',
				width: 2 }, };
			let layout = {
			  width:380,
			  height: 280,
			  paper_bgcolor: "lightblue",
			  plot_bgcolor: "#ddd",
			  title: {
				text:"<b>" + myDiv + "<br>Flujo actual: </b>" + parseFloat(nivel).toFixed(2) + " ft3/s" + "</br>",
				font: { color:'black', family: 'Arial', size: 24 }},
			  xaxis: {
				title: {
				  text: "<b>Fecha/Hora<b>", },
				linecolor:'black',
				mirror: true,
				gridwidth:2,
				gridcolor:'grey',
				gridwidth:1, },
			  yaxis: {
				title: {
				  text: "<b>Flujo[ft3/s]<b>", },
				linecolor:'black',
				mirror: true,
				gridcolor:'grey',
				gridwidth:1,
				tickformat: ".2f", }, }
			let graphData = [trace];
			Plotly.newPlot('plot',graphData,layout);  
		}
		////////////////////////////////////////////
		// Funcion que crea marcadores para cada río
		////////////////////////////////////////////
		function createMarker(miRio)
		{
		  Plotly.d3.text("https://waterdata.usgs.gov/nwis/uv?cb_00060=on&format=rdb&site_no=" + miRio, function(data){
			let lat = siteDict[miRio].lat,
				lon = siteDict[miRio].lon,
				nombre = siteDict[miRio].nombre,
				tsID = siteDict[miRio].tsID,
				webID = siteDict[miRio].webID,
				circulo1, circulo2, circulo3, circulo4, circulo5, circulo6, circulo7,
				datos = filtraDatos(data),
				nivel = datos[1].pop(),
				mensaje = "Soy " + nombre + " <br> Tengo una descarga de " + parseFloat(nivel).toFixed(2) + " ft3/s";
			Plotly.d3.text("https://waterdata.usgs.gov/nwis/dvstat?&site_no="+ miRio +"&agency_cd=USGS&por_"+ miRio +"_"+ tsID +"="+ webID +",00060,"+ tsID +"&referred_module=sw&format=rdb", function(data){
			  let datos2 = filtraDatos2(data);
			  let p05 = datos2[1],
				  p10 = datos2[2],
				  p20 = datos2[3],
				  p25 = datos2[4],
				  p50 = datos2[5],
				  p75 = datos2[6],
				  p80 = datos2[7],
				  p90 = datos2[8],
				  p95 = datos2[9];
			  if (nivel <= 5)
			  {
				circulo1 = L.circle([lat,lon],
									{color: 'red',
									 colorOpacity:1.0,
									 fillColor:'red',
									 fillOpacity:1.0,
									 radius: 2000}).bindTooltip(nombre, {permanent: true, className: "my-label", offset: [0, 30], opacity: 1.0, direction: 'center'}).addTo(mymap);
				circulo1.bindPopup('<div id="plot"></div>',{Position: 'absolute', maxWidth:"auto", offset: [-190,-20]})
							.on('popupopen', function(e) {graficaDatos(datos, nombre)})
			  }
			  else if (nivel > 5 && nivel < 10)
			  {
				circulo2 = L.circle([lat,lon],
									{color: 'darkred',
									 colorOpacity:1.0,
									 fillColor:'darkred',
									 fillOpacity:1.0,
									 radius: 2000}).bindTooltip(nombre, {permanent: true, className: "my-label", offset: [0, 30], opacity: 1.0, direction: 'center'}).addTo(mymap);
				circulo2.bindPopup('<div id="plot"></div>',{Position: 'absolute', maxWidth:"auto", offset: [-190,-20]})
							.on('popupopen', function(e) {graficaDatos(datos, nombre)})
			  }
			  else if (nivel >= 10 && nivel <= 24)
			  {
				circulo3 = L.circle([lat,lon],
									{color: 'orange',
									 colorOpacity:1.0,
									 fillColor:'orange',
									 fillOpacity:1.0,
									 radius: 2000}).bindTooltip(nombre, {permanent: true, className: "my-label", offset: [0, 30], opacity: 1.0, direction: 'center'}).addTo(mymap);
				circulo3.bindPopup('<div id="plot"></div>',{Position: 'absolute', maxWidth:"auto", offset: [-190,-20]})
							.on('popupopen', function(e) {graficaDatos(datos, nombre)})
			  }
			  else if (nivel >= 25 && nivel <= 75)
			  {
				circulo4 = L.circle([lat,lon],
									{color: 'green',
									 colorOpacity:1.0,
									 fillColor:'green',
									 fillOpacity:1.0,
									 radius: 2000}).bindTooltip(nombre, {permanent: true, className: "my-label", offset: [0, 30], opacity: 1.0, direction: 'center'}).addTo(mymap);
				circulo4.bindPopup('<div id="plot"></div>',{Position: 'absolute', maxWidth:"auto", offset: [-190,-20]})
							.on('popupopen', function(e) {graficaDatos(datos, nombre)})
			  }
			  else if (nivel >= 76 && nivel <= 90)
			  {
				circulo5 = L.circle([lat,lon],
									{color: 'lightblue',
									 colorOpacity:1.0,
									 fillColor:'lightblue',
									 fillOpacity:1.0,
									 radius: 2000}).bindTooltip(nombre, {permanent: true, className: "my-label", offset: [0, 30], opacity: 1.0, direction: 'center'}).addTo(mymap);
				circulo5.bindPopup('<div id="plot"></div>',{Position: 'absolute', maxWidth:"auto", offset: [-190,-20]})
							.on('popupopen', function(e) {graficaDatos(datos, nombre)})
			  }
			  else if (nivel > 90 && nivel <= 95)
			  {
				circulo6 = L.circle([lat,lon],
									{color: 'blue',
									 colorOpacity:1.0,
									 fillColor:'blue',
									 fillOpacity:1.0,
									 radius: 2000}).bindTooltip(nombre, {permanent: true, className: "my-label", offset: [0, 30], opacity: 1.0, direction: 'center'}).addTo(mymap);
				circulo6.bindPopup('<div id="plot"></div>',{Position: 'absolute', maxWidth:"auto", offset: [-190,-20]})
							.on('popupopen', function(e) {graficaDatos(datos, nombre)})
			  }
			  else if (nivel > 95)
			  {
				circulo7 = L.circle([lat,lon],
									{color: 'black',
									 colorOpacity:1.0,
									 fillColor:'black',
									 fillOpacity:1.0,
									 radius: 2000}).bindTooltip(nombre, {permanent: true, className: "my-label", offset: [0, 30], opacity: 1.0, direction: 'center'}).addTo(mymap);
				circulo7.bindPopup('<div id="plot"></div>',{Position: 'absolute', maxWidth:"auto", offset: [-190,-20]})
							.on('popupopen', function(e) {graficaDatos(datos, nombre)})
			  }
			})
		  });
		}
		/////////////
		// Leyenda //
		/////////////
		function leyendamostrar()
		{
		  var leyenda = L.control({position: 'bottomleft'});
		  leyenda.onAdd = function (mymap)
		  {
			var div = L.DomUtil.create('div', 'info leyenda'),
				niveles = ['Alto', '>90', '76-90', '25-75', '10-24', '<10', 'Bajo'],
				colores = ['black', 'blue', 'lightblue', 'green', 'orange', 'darkred', 'red'];
			div.innerHTML += "<h4>Percentil</h4>";
			for(let i=0; i < 7; i++)
			{
			  div.innerHTML += '<i style="background:'+colores[i]+'"></i><span>'+niveles[i]+'</span><br>';
			}
			return div;
		  };
		  leyenda.addTo(mymap);
		}
		//////////////////////////////////////
		// Funcion que muestra la fecha actual
		//////////////////////////////////////
		function actualizar()
		{
		  var actualizacion = L.control({position: 'bottomright'});
		  actualizacion.onAdd = function(mymap)
		  {
			var div2 = L.DomUtil.create('div', 'actualizacion');
			if (fecha1.slice(16,18) >= 12)
			{
			  div2.innerHTML += "<h4>Última actualización: "+(nameDia[dia]+" "+fecha1.slice(8,10)+" de "+nameMes[mes]+" del "+fecha1.slice(11,15)+" "+horas[hora]+fecha1.slice(18,24)+" PM")+"</h4>";
			}
			else
			{
			  div2.innerHTML += "<h4>Última actualización: "+(nameDia[dia]+" "+fecha1.slice(8,10)+" de "+nameMes[mes]+" del "+fecha1.slice(11,15)+" "+horas[hora]+fecha1.slice(18,24)+" AM")+"</h4>"; 
			}
			return div2;
		  };
		  actualizacion.addTo(mymap);
		}
		//////////////////////////////
		// Funcion que imprime el mapa
		//////////////////////////////
		function procesaRio()
		{
		  for(const [key,value] of Object.entries(siteDict))
		  {
			createMarker(key);
		  }
		}
		createDictionary();
		inicializaMapa();
		leyendamostrar();
		actualizar();
		setTimeout(procesaRio,500); </script>
          </div>
          <style> .leyenda {
	  padding: 6px 8px;
	  font: 14px Arial, Helvetica, sans-serif;
	  background: grey;
	  box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
	  border-radius: 5px;
	  line-height: 24px;
	  color: #555;
	  opacity: 0.75
	}
	.leyenda h4 {
	  text-align: center;
	  font-size: 18px;
	  margin: 2px 12px 8px;
	  color: white;
	  opacity: 0.85;
	}
	.leyenda span {
	  position: relative;
	  bottom: 3px;
	  color: white;
	  opacity: 0.85;
	}
	.leyenda i {
	  width: 18px;
	  height: 18px;
	  float: left;
	  margin: 0 8px 0 0;
	  opacity: 0.75;
	}
	.actualizacion {
	  padding: 6px 8px;
	  font: 14px Arial, Helvetica, sans-serif;
	  background: black;
	  opacity: 0.75;
	  box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
	  border-radius: 5px;
	  line-height: 24px;
	  color: #555;
	}
	.actualizacion h4 {
	  text-align: center;
	  font-size: 18px;
	  margin: 2px 12px 8px;
	  color: white;
	  opacity: 0.85;
} </style>
        </div>
      </div>
    </section>
    
    
    <footer class="u-align-center u-clearfix u-footer u-grey-80 u-footer" id="sec-985b"><div class="u-clearfix u-sheet u-valign-middle u-sheet-1">
        <p class="u-align-center u-small-text u-text u-text-variant u-text-1">© Copyright. 2021, Yadiel Torres. Todos los derechos reservados.</p>
      </div></footer>
  </body>
</html>